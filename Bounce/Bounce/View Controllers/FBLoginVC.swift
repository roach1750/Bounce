//
//  FBLoginVC.swift
//  Bounce
//
//  Created by Andrew Roach on 2/15/16.
//  Copyright Â© 2016 Andrew Roach. All rights reserved.
//

import UIKit
import FBSDKCoreKit
import FBSDKLoginKit


class FBLoginVC: UIViewController, FBSDKLoginButtonDelegate {
    
    
    @IBOutlet weak var profilePictureView: FBSDKProfilePictureView!
    
    @IBOutlet weak var continueButton: UIButton!
    
    @IBOutlet weak var nameLabel: UILabel!
    
    override func viewDidLoad() {
        if KCSUser.activeUser() != nil {
            print("there is a current kinvey user named \(KCSUsername)")
        }
        self.view.backgroundColor = UIColor(red: 25.0 / 255.0, green: 181.0 / 255.0, blue: 146.0 / 255.0, alpha: 1.0)
        super.viewDidLoad()
        nameLabel.text = ""
        if FBSDKAccessToken.currentAccessToken() == nil {
            print("Not Login")
            self.continueButton.setTitle("Continue without facebook...", forState: .Normal)
            
        }
        else {
            print("Already Logged in")
            self.continueButton.setTitle("Let's Bounce!", forState: .Normal)
            let userFetcher = UserFetcher()
            userFetcher.updateUserFriends()
        }
        let loginButton = FBSDKLoginButton()
        loginButton.readPermissions = ["public_profile", "email", "user_friends"]
        loginButton.center = self.view.center
        loginButton.delegate = self
        self.view.addSubview(loginButton)
        
        
        NSNotificationCenter.defaultCenter().addObserver(self, selector: #selector(FBLoginVC.changeContinueToLoggedInText), name: BOUNCEUSERLOGGEDIN, object: nil)
        
    }
    
    func changeContinueToLoggedInText() {
        self.continueButton.setTitle("Let's Bounce!", forState: .Normal)
        
    }
    
    
    func loginButton(loginButton: FBSDKLoginButton!, didCompleteWithResult result: FBSDKLoginManagerLoginResult!, error: NSError!)
    {
        if FBSDKAccessToken.currentAccessToken() != nil {
            //We have a successful login, need fetch user's information:
            let userFetcher = UserFetcher()
            userFetcher.createUser()
        }
        
        
    }
    
    func loginButtonDidLogOut(loginButton: FBSDKLoginButton!) {
        if KCSUser.activeUser() != nil {
            KCSUser.activeUser().removeWithCompletionBlock { (objectsOrNil: [AnyObject]!, errorOrNil: NSError!) -> Void in
                if errorOrNil != nil {
                    NSLog("error %@ when deleting active user", errorOrNil)
                } else {
                    NSLog("active user deleted")
                }
            }
        }
        print("User Logged Out")
    }
    
    
    
    @IBAction func continueToBounceButtonPressed(sender: UIButton) {
        //If there is no user, autogenerate a user:
        if KCSUser.activeUser() == nil {
            KCSUser.createAutogeneratedUser(
                [
                    KCSUserAttributeEmail : "kinvey@kinvey.com",
                    KCSUserAttributeGivenname : "Arnold",
                    KCSUserAttributeSurname : "Kinvey"
                ],
                completion: { (user: KCSUser!, errorOrNil: NSError!, result: KCSUserActionResult) -> Void in
                    //do something
                }
            )
        } else {
            
        }
        
    }
    
    
    
    
    
}
